---
title: "3.5 Windows Server – Domäner och AD"
parent: "Nätverk"
nav_order: 305
---

# 3.5 Windows Server – Domäner och AD

### 3.5.1 Överblick: vad är en domän och Active Directory (AD DS)?
En domän är en överenskommelse om identiteter och regler: vem du är, vad du får, och hur det bevisas på ett sätt som alla datorer i domänen litar på. Active Directory Domain Services (AD DS) är katalogen som håller ihop detta – ett “telefonregister med hjärna” som lagrar konton, grupper, datorer, skrivare och relationer mellan dem. När en användare loggar in händer tre saker i snabb följd: klienten hittar en domänkontrollant (via DNS), bevisar vem användaren är (Kerberos/NTLM), och hämtar regler och resurser som hör till identiteten (GPO, gruppmedlemskap, rättigheter). I större miljöer delas katalogen in i flera domäner under samma skog (forest), där skogens gemensamma språk – schemat – gör att alla förstår samma objekttyper. För en skola betyder detta att inloggning och datorupplevelse kan vara lika i alla salar, samtidigt som administration kan delegeras lokalt utan att ge bort “superkrafter”.
Förtydligande (sammanfattning):
- Domän: en gemensam säkerhetsgräns och policyyta.
- Skog: en eller flera domäner som delar schema och kan lita på varandra.
- Domänkontrollant (DC): server som autentiserar och replikerar katalogen.
Domän: en gemensam säkerhetsgräns och policyyta.
Skog: en eller flera domäner som delar schema och kan lita på varandra.
Domänkontrollant (DC): server som autentiserar och replikerar katalogen.
Exempel: En elev får samma skrivare och samma hemkatalog oavsett dator. Det är inte “turen” som avgör, utan domänens identitets- och policylogik.
### 3.5.2 Grundkomponenter: DC, FSMO-roller, tid och platser (Sites)
En domän behöver flera domänkontrollanter av samma skäl som en stad behöver fler än ett sjukhus: driftstopp ska inte bli en kris. Vissa uppgifter är “ensamrättsroller” – FSMO – för att undvika kollisioner (t.ex. schemaändringar, tilldelning av SID-delar). Den mest synliga i vardagen är PDC Emulatorn, som fungerar som tidsreferens och där många lösenordsrelaterade uppgifter prioriteras. Tid låter trivialt, men i Kerberos är den en säkerhetsparameter: ligger klockorna fel upphör biljetterna att gälla. I ett nät som täcker flera byggnader hjälper Sites and Services AD att förstå geografin: klienter i Hus A ska i första hand använda “sin” DC, och replikering mellan hus kan ske med rimliga intervall.
Förtydligande (sammanfattning):
- Minst två DC: för robusthet och underhåll.
- FSMO: särskilda ansvar som inte mår bra av att vara “flera samtidigt”.
- Tidssynk: en kedja från PDC Emulator → övriga DC → klienter.
- Sites: kopplar subnät till “närmaste” DC och styr replikering.
Minst två DC: för robusthet och underhåll.
FSMO: särskilda ansvar som inte mår bra av att vara “flera samtidigt”.
Tidssynk: en kedja från PDC Emulator → övriga DC → klienter.
Sites: kopplar subnät till “närmaste” DC och styr replikering.
Exempel: När en ny elev byter lösenord på morgonen ska samma lösenord gälla i alla hus efter minuter, inte timmar. Det är replikeringstopologin som gör det möjligt.
### 3.5.3 DNS-integrering – AD:s nervsystem
AD lutar sig mot DNS i nästan varje steg. När en klient vill logga in måste den hitta en DC genom att slå upp särskilda SRV-poster i den interna zonen. Därför lagras zonen ofta AD-integrerat: den följer med katalogens replikering och accepterar säkra, dynamiska uppdateringar från domänanslutna maskiner. Det gör att en dator automatiskt kan registrera sig med rätt namn och att klienter spontant hittar rätt väg även när adresser ändras. Fel i den här kopplingen maskerar sig gärna som “AD-problem”, men roten är ofta att någon dator råkar fråga fel DNS (t.ex. en publik resolver som inte känner till interna SRV-poster).
Förtydligande (sammanfattning):
- SRV-poster: “här finns LDAP/Kerberos för den här domänen”.
- AD-integrerad zon: säker dynamik + samma replikering som katalogen.
- Klientupplevelse: rätt DNS på klienten är en förutsättning för “AD funkar”.
SRV-poster: “här finns LDAP/Kerberos för den här domänen”.
AD-integrerad zon: säker dynamik + samma replikering som katalogen.
Klientupplevelse: rätt DNS på klienten är en förutsättning för “AD funkar”.
Exempel: En dator kan surfa men “hittar inte domänen”. Förklaringen är ofta att DNS pekar på internet istället för skolans egna resolvers – då syns aldrig AD:s SRV-poster.
### 3.5.4 OU-design och delegation
OU:er (Organizational Units) är katalogens ordning och reda. De fungerar både som mappar för att gruppera liknande objekt och som gränser där man kan fästa policyer och ansvar. En bra design speglar driften: datorer för elever, personal och servrar i skilda grenar; underindelning per hus eller sal när det hjälper arbetet; och tydliga platser där delegering sker utan att släppa in någon på fel nivå. Principen LSDOU (Local → Site → Domain → OU) berättar i vilken ordning policyer tolkas; den sista som passar vinner – med undantag för några specialflaggor. Poängen är att kunna uttrycka “hur ska det vara här?” utan att behöva uppfinna regler på varje enskild dator.
Förtydligande (sammanfattning):
- Struktur efter drift: vem äger vad, vem behöver ändra vad, var gäller vilka regler?
- Placera objekt rätt: lämna standardcontainrar, lägg i OU.
- Delegation: ge “lagom” makt nära där jobbet sker.
Struktur efter drift: vem äger vad, vem behöver ändra vad, var gäller vilka regler?
Placera objekt rätt: lämna standardcontainrar, lägg i OU.
Delegation: ge “lagom” makt nära där jobbet sker.
Exempel: En datasal kan få hårdare skrivbordspolicyer än lärarrummet, även om samma elev loggar in på båda. Det avgörs av datorns OU och hur policyerna är kopplade.
### 3.5.5 GPO – hur policyn “blir verklighet”
Group Policy är verktygslådan där datorinställningar och användarinställningar bor. När en användare loggar in “läggs” deras egna regler ovanpå datorns regler enligt LSDOU. Ibland vill man tvärtom: att datorns plats bestämmer även användarupplevelsen – då används loopback processing (t.ex. i datasalar). Security Filtering och ibland WMI-filter gör att en policy träffar rätt grupp eller rätt sorts dator, och SYSVOL bär runt själva innehållet så alla DC:er kan dela på jobbet. Allt detta är osynligt när det fungerar, men tydligt när det inte gör det: GPO är den tysta kraften bakom “samma upplevelse varje dag”.
Förtydligande (sammanfattning):
- Två sidor: dator- vs användarpolicys.
- Ordning: Local → Site → Domain → OU (senast relevant “vinner”).
- Riktning: filtrera på grupp eller egenskap; loopback när rummet ska styra.
Två sidor: dator- vs användarpolicys.
Ordning: Local → Site → Domain → OU (senast relevant “vinner”).
Riktning: filtrera på grupp eller egenskap; loopback när rummet ska styra.
Exempel: Om alla i datasalen ska se samma startmeny oavsett vem de är, låter man datorernas OU tala högst via loopback. Då följer upplevelsen rummet, inte personen.
### 3.5.6 Konton, grupper och rättigheter (AGDLP, UPN, lösenpolicy, gMSA)
Identitet i AD blir begriplig först när konton och grupper hålls isär i tanken. Kontot beskriver en person eller en tjänst; gruppen beskriver en roll. Med UPN-formatet (namn@domän) känns inloggning igen från andra tjänster. AGDLP är bara ett sätt att säga att vi först samlar människor i passande globala grupper, sedan kopplar rollerna till resurser via Domain Local-grupper som bär behörigheten. För tjänster är gMSA en tryggare variant än lokala konton med “hemliga” lösenord – domänen sköter rotationen. Tillsammans ger detta ett språk där förändringar i verkligheten (en elev byter klass, en lärare byter roll) speglas av gruppmedlemskap, inte av specialfall på resurserna.
Förtydligande (sammanfattning):
- Kontot = individ/tjänst, gruppen = roll.
- AGDLP: skär isär “vem” och “var” så att behörigheter blir underhållbara.
- gMSA: minskar riskerna med tjänstkonton och stillastående lösenord.
Kontot = individ/tjänst, gruppen = roll.
AGDLP: skär isär “vem” och “var” så att behörigheter blir underhållbara.
gMSA: minskar riskerna med tjänstkonton och stillastående lösenord.
Exempel: När en elev byter program byts inte “filservern” – bara gruppen hen tillhör. Därför följer rättigheter och skrivare med på köpet.
### 3.5.7 Användarrättigheter i OS vs rättigheter till filer och mappar
Det är lätt att blanda ihop två olika sorters rättigheter: User Rights Assignment i operativsystemet handlar om vad ett konto får göra mot datorn (logga in, köra som tjänst, ta ägarskap), medan NTFS- och share-rättigheter handlar om vad kontot får göra mot data. Den första påverkar inloggning och tjänster, den andra påverkar mappar och filer. I praktiken leder tydlig gruppbaserad hantering till färre överraskningar: datorn vet vilka som får logga in; filservern vet vilka som får läsa och skriva – och de två världarna korsar bara varandra där de måste.
Förtydligande (sammanfattning):
- User Rights: OS-beteenden (t.ex. “Log on as a service”).
- NTFS/Share: dataåtkomst; effektiv rätt = snittet av båda.
- Gruppbaserat: stabilare än individuella undantag.
User Rights: OS-beteenden (t.ex. “Log on as a service”).
NTFS/Share: dataåtkomst; effektiv rätt = snittet av båda.
Gruppbaserat: stabilare än individuella undantag.
Exempel: En tjänst vägrar starta “trots admin”. Felet är ofta att kontot saknar själva rätten att köras som tjänst, vilket inte är samma sak som filrättigheter.
### 3.5.8 DHCP i domänmiljö (autorisering, redundans, namn)
DHCP i en domän är inte bara “adressutdelning”, utan också tillit och namn. Servern behöver vara auktoriserad i katalogen för att få dela ut adresser – ett skydd mot oväntade källor. Två servrar kan arbeta tillsammans så att utdelningen fortsätter även under patchar och fel. Och eftersom namnet betyder mycket i en AD-miljö är det vanligt att låta DHCP hjälpa till med dynamiska DNS-uppdateringar, så att “vem bor var?”-frågan alltid har ett rimligt svar. Allt detta är små detaljer var för sig, men tillsammans gör de att klassrum “bara fungerar” när många maskiner kommer och går varje dag.
Förtydligande (sammanfattning):
- Autorisering: domänen godkänner DHCP som “talar för den”.
- Redundans: två servrar delar ansvar.
- DNS-uppdatering: adresser får namn och namn får adresser utan handpåläggning.
Autorisering: domänen godkänner DHCP som “talar för den”.
Redundans: två servrar delar ansvar.
DNS-uppdatering: adresser får namn och namn får adresser utan handpåläggning.
Exempel: I elevnätet byts adresser ofta. När DHCP och DNS pratar med varandra slipper du spökinlägg – namnen pekar dit datorerna faktiskt finns just nu.
### 3.5.9 Fildelning – struktur, NTFS vs share, ABE, VSS och GPP
En filserver är inte bara en hårddisk på nätet; den är en scenografi för hur människor arbetar. Genom att skilja på share-rättigheter (grov grind vid ingången) och NTFS-rättigheter (finmaskig styrning inne i huset) går det att uttrycka “alla som kommer in i den här korridoren får läsa – men bara vissa får öppna klassrumsdörrarna”. Access-Based Enumeration (ABE) döljer dörrar du ändå inte får öppna, vilket gör upplevelsen lugnare och säkrare. Skuggkopior (VSS) låter användare backa tiden själva när någonting råkade bli fel, och Group Policy Preferences gör att rätt diskar dyker upp där de behövs, kopplade till roller istället för datorbilder. Med den här kompositionen blir filservern begriplig: du ser det du ska se, och det du gör går att ångra.
Förtydligande (sammanfattning):
- Share = grov nivå, NTFS = fin nivå.
- ABE minskar “kan inte öppna”-support.
- VSS och GPP ger mindre friktion i vardagen.
Share = grov nivå, NTFS = fin nivå.
ABE minskar “kan inte öppna”-support.
VSS och GPP ger mindre friktion i vardagen.
Exempel: En elev ser bara sin klassmapp och sin hemkatalog. Läraren ser dessutom ämnesmappar. Blir något fel i gårdagens dokument finns “Tidigare versioner” ett högerklick bort.
### 3.5.10 Standardmönster för behörighet: AGDLP i praktiken
Det är viktigt att tänka på att AGDLP används konsekvent eftersom det separerar vem som behöver åtkomst från var åtkomsten faktiskt ges. I praktiken innebär det att individuella konton samlas i globala grupper (per roll, klass eller funktion) för att visa vilka personer som hör ihop. Dessa globala grupper läggs i sin tur in i Domain Local-grupper som är knutna till resurserna (t.ex. en fildelning eller en applikation) och som bär själva behörigheten. Poängen är att förändringar i personal, klasser eller roller kan göras genom att bara flytta medlemmar mellan globala grupper – utan att behöva röra de känsliga behörighetslistorna på resurserna. På det sättet minskar risken för misstag, och helpdesk kan lösa de flesta åtkomstärenden snabbt och spårbart.
Namnstandarden blir också en del av läsbarheten. Om Domain Local-gruppen berättar vilken resurs och nivå den representerar (t.ex. DL_Share_Personal_Modify) och den globala gruppen berättar vilken roll den samlar (t.ex. G_Larare eller G_23TE) blir behörighetstabellen nästan självdokumenterande. Att dessutom ange en ägare för varje DL-grupp gör att det alltid är tydligt vem som får besluta om medlemskap – något som är viktigt i en skolmiljö där klasser byts och personal tillkommer över tid. Om miljön växer till flera domäner i samma skog kan Universal-grupper användas som ett mellansteg, men grundidén är densamma: separera människorna från resurserna och låt grupperna vara “kopplingsdosor” mellan dem.
Exempel: När en ny lärare börjar läggs kontot i G_Larare. Den gruppen är redan medlem i DL_Share_Personal_Modify, som i sin tur har NTFS-rättigheten Modify på \\srv-fil-01\Personal. Läraren får åtkomst utan att någon behöver öppna NTFS-dialogen — och när läraren slutar räcker det att ta bort kontot ur G_Larare.
### 3.5.11 Felsökning: var börjar jag, och varför just där?
När något “AD-relaterat” strular är namn och tid de två första frågorna. Utan rätt DNS hittar klienten inte sin DC, och utan rimlig tid accepterar Kerberos inte biljetten. Därifrån följer två spår: replikering (delar DC:erna samma bild av världen?) och policytillämpning (träffar policyn rätt objekt, på rätt plats?). Genom att hålla sig till den ordningen blir felsökningen mindre magi och mer metod: vi slår fast “vad fungerar”, ringar in “var slutar det fungera”, och låter detaljerna leda oss vidare.
Förtydligande (sammanfattning):
- DNS först, tid sen: de är fundamenten.
- Replikering: en sanning i katalogen, inte många halvsanningar.
- Policy: rätt plats, rätt riktning, rätt villkor – annars händer “inget”.
DNS först, tid sen: de är fundamenten.
Replikering: en sanning i katalogen, inte många halvsanningar.
Policy: rätt plats, rätt riktning, rätt villkor – annars händer “inget”.
Exempel: En dator i datasalen får inte “datasalsupplevelsen”. Felet visar sig vara att den flyttats till fel OU – policyn missar helt enkelt målet.
### 3.5.12 Rekommenderade bas-GPO:er (varför just de?)
Det är bra att etablera ett litet grundgolv av policyer som alltid finns, eftersom det ger förutsägbarhet i undervisningen och minskar antalet incidenter. Windows Update med en enkel “ring”-modell (test → pilot → brett) hjälper till att få ut säkerhetsfixar utan att riskera att en hel datasal tappar funktion samma dag; några maskiner får först, resten när det visat sig stabilt. Windows-brandväggen med korrekta profiler (domän/privat/offentlig) säkerställer att samma dator beter sig olika i skolnät och hemma — öppet där det måste vara öppet, stängt i övrigt. Tid/NTP styrs centralt för att Kerberos ska fungera; en liten tidsdrift räcker för att inloggningar och biljetter ska börja fallera.
Windows LAPS motiveras av att lokala administratörslösenord inte ska återanvändas mellan datorer; varje maskin får ett unikt, roterande lösenord som går att läsa vid behov, vilket minskar risken för lateral förflyttning. Att stänga Telnet och andra legacy-protokoll handlar om att ta bort onödiga angreppsytor – moderna, krypterade protokoll räcker. RDP bör vara tillåtet endast från management-nät eller via bastion, för att inte exponera administrativa gränssnitt i elev- och personalnät. Audit-policyer (inloggningar, policyändringar, åtkomstförsök) gör det möjligt att efterhand förstå “vad som hände” när något går fel eller när en incident måste följas upp.
Till det kommer Group Policy Preferences för skrivare och enhetskopplingar (P:, S: osv.). Poängen är att kopplingar då följer grupper snarare än enskilda datorbilder – när en elev byter klass följer skrivare och mappar med utan manuell handpåläggning. En standardiserad startmeny i datasalar gör att lektioner börjar likadant oavsett vilken dator man sätter sig vid; både elever och lärare sparar tid när viktiga program ligger på samma plats. Slutligen är det klokt att versionera policyer och dokumentera var de är länkade, för att korta vägen från “något ändrades” till “nu vet vi vad”.
Exempel: En ny datasal får samma upplevelse som de andra eftersom “Datasal-Golv” redan innehåller brandväggsprofiler, LAPS, RDP-begränsning, audit och standardmeny. Skrivare och nätverksenheter kopplas in via GPP baserat på grupper, så lärarna slipper jaga genvägar.
### 📌 Kontrollfrågor
- Vad betyder det att en domän är en säkerhetsgräns, och hur märks det i vardagen?
- Varför är tid en säkerhetsfråga i en AD-miljö, och vilken roll spelar PDC Emulatorn?
- Hur hänger DNS ihop med inloggningen, och vilka symptom får du när klienten frågar “fel” resolver?
- På vilket sätt hjälper OU:er både policys och delegation, och varför bör standardcontainrar undvikas?
- Förklara LSDOU och ge ett exempel där loopback är nyckeln till rätt upplevelse.
- Vad vinner du på att tänka konton = individer/tjänster och grupper = roller?
- Varför är AGDLP lättare att underhålla än individuella rättigheter direkt på resurser?
- Vad skiljer User Rights i OS från NTFS-/share-rättigheter, och varför är den skillnaden viktig?
- Hur bidrar DHCP-autorisation och dynamiska DNS-uppdateringar till att domäninloggning “bara funkar”?
- Vad gör ABE, VSS och GPP för skillnad i en filservermiljö för skola?
Vad betyder det att en domän är en säkerhetsgräns, och hur märks det i vardagen?
Varför är tid en säkerhetsfråga i en AD-miljö, och vilken roll spelar PDC Emulatorn?
Hur hänger DNS ihop med inloggningen, och vilka symptom får du när klienten frågar “fel” resolver?
På vilket sätt hjälper OU:er både policys och delegation, och varför bör standardcontainrar undvikas?
Förklara LSDOU och ge ett exempel där loopback är nyckeln till rätt upplevelse.
Vad vinner du på att tänka konton = individer/tjänster och grupper = roller?
Varför är AGDLP lättare att underhålla än individuella rättigheter direkt på resurser?
Vad skiljer User Rights i OS från NTFS-/share-rättigheter, och varför är den skillnaden viktig?
Hur bidrar DHCP-autorisation och dynamiska DNS-uppdateringar till att domäninloggning “bara funkar”?
Vad gör ABE, VSS och GPP för skillnad i en filservermiljö för skola?
### 🔗 Fördjupningslänkar
- Microsoft Learn – Active Directory Domain Services (översikt): https://learn.microsoft.com/windows-server/identity/ad-ds/get-started/active-directory-domain-services-overview
- DNS i AD (SRV, AD-integrerade zoner, dynamiska uppdateringar): https://learn.microsoft.com/windows-server/identity/ad-ds/plan/active-directory-integrated-dns
- Group Policy – grunder, loopback, filtrering: https://learn.microsoft.com/windows/security/threat-protection/security-policy-settings/
- DHCP Server – auktorisering, failover, DDNS: https://learn.microsoft.com/windows-server/networking/technologies/dhcp/dhcp-top
- File and Storage Services – NTFS, SMB, ABE, FSRM, VSS: https://learn.microsoft.com/windows-server/storage/file-server/file-server
- Windows LAPS: https://learn.microsoft.com/windows-server/identity/laps/laps-overview
- AD-replikering och DC-hälsa (repadmin, dcdiag): https://learn.microsoft.com/troubleshoot/windows-server/identity/active-directory-replication-troubleshooting
Microsoft Learn – Active Directory Domain Services (översikt): https://learn.microsoft.com/windows-server/identity/ad-ds/get-started/active-directory-domain-services-overview
DNS i AD (SRV, AD-integrerade zoner, dynamiska uppdateringar): https://learn.microsoft.com/windows-server/identity/ad-ds/plan/active-directory-integrated-dns
Group Policy – grunder, loopback, filtrering: https://learn.microsoft.com/windows/security/threat-protection/security-policy-settings/
DHCP Server – auktorisering, failover, DDNS: https://learn.microsoft.com/windows-server/networking/technologies/dhcp/dhcp-top
File and Storage Services – NTFS, SMB, ABE, FSRM, VSS: https://learn.microsoft.com/windows-server/storage/file-server/file-server
Windows LAPS: https://learn.microsoft.com/windows-server/identity/laps/laps-overview
AD-replikering och DC-hälsa (repadmin, dcdiag): https://learn.microsoft.com/troubleshoot/windows-server/identity/active-directory-replication-troubleshooting
### ✍️ Egna anteckningar
…