# Kapitel 1 ‚Äì Vad √§r ett n√§tverk?

## 2.4 DHCP, DNS och NAT

### 2.4.1 DHCP ‚Äì grunder

DHCP automatiserar utdelningen av n√§tverksparametrar till klienter: IP-adress, subn√§tmask/prefix, default gateway och DNS-servrar. N√§r en klient ansluter skickar den en broadcast (DISCOVER) f√∂r att hitta en server. Servern svarar med ett OFFER, klienten accepterar med REQUEST, och servern bekr√§ftar med ACK ‚Äì den klassiska DORA-processen. Den tilldelade adressen beh√•lls under en lease (tidsperiod) som klienten f√∂rnyar innan den g√•r ut. Ut√∂ver grundv√§rden kan DHCP skicka options (t.ex. router = option 3, DNS = option 6, dom√§nsuffix = option 15, NTP = option 42).

Exempel: Exempel: En elevdator i VLAN 20 startas och ropar efter adress. Gatewayn vidarebefordrar (relay) DHCP-f√∂rfr√•gan till skolans centrala server. Klienten f√•r 10.20.1.57/22, gateway 10.20.0.1 och DNS 10.40.0.10‚Äì11.

F√∂rtydligande (sammanfattning):

- DORA: Discover ‚Üí Offer ‚Üí Request ‚Üí Ack.
- Lease: giltighetstid; f√∂rnyas automatiskt.
- Options: extra parametrar (t.ex. 3, 6, 15, 42).
- Reservation: fast IP till specifik MAC (skrivare/servrar).

DORA: Discover ‚Üí Offer ‚Üí Request ‚Üí Ack.

Lease: giltighetstid; f√∂rnyas automatiskt.

Options: extra parametrar (t.ex. 3, 6, 15, 42).

Reservation: fast IP till specifik MAC (skrivare/servrar).

### 2.4.2 DHCP-design: scopes, relay och robusthet

I segmenterade n√§t finns ofta en central DHCP-server som servar flera VLAN via DHCP relay (ibland ‚ÄúIP helper‚Äù) p√• gatewayn. Varje VLAN f√•r ett scope som matchar dess subn√§t; intervall f√∂r statisk adressering (gateway, switchar, brandv√§gg) exkluderas fr√•n utdelningen. Lease time anpassas efter m√•lgruppen: kortare f√∂r g√§stn√§t med h√∂g oms√§ttning, l√§ngre f√∂r personal. F√∂r robusthet k√∂r man tv√• servrar i failover (load share eller hot-standby). S√§kerhet i accesslagret st√§rks med DHCP Snooping som hindrar falska DHCP-servrar.

Exempel: Exempel: VLAN 30 (G√§st) har lease time 8 h och rate-limits mot internet. VLAN 10 (Personal) har 3‚Äì7 dagar. DHCP Snooping √§r aktivt; endast brandv√§ggens gr√§nssnitt √§r ‚Äútrusted‚Äù f√∂r DHCP.

F√∂rtydligande (sammanfattning):

- Relay: central server n√•r m√•nga VLAN.
- Lease time: kort i g√§st, l√§ngre i personal.
- Failover: tv√• servrar f√∂r h√∂g tillg√§nglighet.
- S√§kerhet: DHCP Snooping i accesslagret.

Relay: central server n√•r m√•nga VLAN.

Lease time: kort i g√§st, l√§ngre i personal.

Failover: tv√• servrar f√∂r h√∂g tillg√§nglighet.

S√§kerhet: DHCP Snooping i accesslagret.

### 2.4.3 DNS ‚Äì grunder

DNS √∂vers√§tter namn ‚Üí IP (och PTR f√∂r IP ‚Üí namn). Systemet √§r hierarkiskt (rot ‚Üí TLD ‚Üí zoner) och bygger p√• att klienter fr√•gar en rekursiv resolver som i sin tur h√§mtar svar fr√•n autoritativa namnservrar. Caching med TTL minskar svarstider och belastning. F√∂rutom A/AAAA-poster anv√§nds CNAME (alias), MX (e-post), TXT (t.ex. SPF/DKIM), SRV (tj√§nster som LDAP/Kerberos i AD) och NS (pekar ut namnservrar). I en AD-milj√∂ √§r SRV-posterna avg√∂rande f√∂r att hitta dom√§nkontrollanter.

Exempel: Exempel: Klienten vill till files.skolan.local. Den fr√•gar skolans resolver, som har zonen autoritativt (AD-integrerad) och svarar direkt: A = 10.40.0.50. Webbl√§saren kontaktar 10.40.0.50 utan att beh√∂va k√§nna till IP fr√•n b√∂rjan.

F√∂rtydligande (sammanfattning):

- A/AAAA, CNAME, MX, TXT, SRV, NS ‚Äì vanligaste posterna.
- Rekursiv resolver ‚Äì fr√•gar vidare och cache:ar.
- TTL ‚Äì styr cache-l√§ngd.
- AD-integrerad DNS ‚Äì n√∂dv√§ndig f√∂r SRV och intern namnl√∂sning.

A/AAAA, CNAME, MX, TXT, SRV, NS ‚Äì vanligaste posterna.

Rekursiv resolver ‚Äì fr√•gar vidare och cache:ar.

TTL ‚Äì styr cache-l√§ngd.

AD-integrerad DNS ‚Äì n√∂dv√§ndig f√∂r SRV och intern namnl√∂sning.

### 2.4.4 DNS-design: split-horizon, forwarders och redundans

I skolor anv√§nds ofta split-horizon DNS: interna namn (t.ex. *.skolan.local) besvaras internt, medan externa namn (*.skolan.se) sl√•s upp mot internet. Rekursiva resolvers kan anv√§nda forwarders (t.ex. operat√∂rens eller en filtrerande tj√§nst) f√∂r att snabba upp svar och till√§mpa policy. Ha minst tv√• resolvers f√∂r redundans och separera dem g√§rna i olika VLAN/zoner. S√§tt l√§mpliga TTL-v√§rden (kortare f√∂r f√∂r√§nderliga poster, l√§ngre f√∂r stabila). Loggning och svarstids√∂vervakning hj√§lper b√•de s√§kerhet och brukarkvalitet.

Exempel: Exempel: Tv√• AD-integrerade DNS:er (10.40.0.10‚Äì11) hanterar skolan.local. F√∂r externa namn anv√§nder de forwarders hos ISP. En tredje, l√§sande resolver i DMZ loggar och alarmerar onormala m√∂nster.

F√∂rtydligande (sammanfattning):

- Split-horizon: interna vs externa zoner.
- Forwarders: snabbar upp, kan filtrera.
- Redundans: minst tv√• resolvers.
- TTL: kort f√∂r r√∂rligt, l√•ngt f√∂r stabilt.

Split-horizon: interna vs externa zoner.

Forwarders: snabbar upp, kan filtrera.

Redundans: minst tv√• resolvers.

TTL: kort f√∂r r√∂rligt, l√•ngt f√∂r stabilt.

### 2.4.5 NAT och PAT ‚Äì grunder och begrepp

NAT44 √∂vers√§tter privata adresser (RFC1918) till publika vid utg√•ng mot internet. Den vanligaste varianten √§r PAT (Port Address Translation, ‚ÄúNAT overload‚Äù) d√§r m√•nga interna klienter delar en publik adress; portnummer skiljer fl√∂dena. SNAT (k√§ll-NAT) anv√§nds vid utg√•ende trafik; DNAT (destination-NAT, ‚Äúport forwarding‚Äù) anv√§nds n√§r externa ska n√• en intern tj√§nst. NAT ger adress√∂vers√§ttning, men ska inte f√∂rv√§xlas med s√§kerhet ‚Äì brandv√§ggsregler beh√∂vs fortfarande. I IPv6 ers√§tts NAT i normalfallet av brandv√§ggspolicy; man anv√§nder globala unicast-adresser och segmentering i st√§llet (NPTv6 kan f√∂rekomma i specialfall).

Exempel: Exempel: Skolan har publik IP 203.0.113.10 p√• brandv√§ggen. Utg√•ende trafik fr√•n VLAN 20 (10.20.0.0/22) SNAT:as till 203.0.113.10 (PAT). F√∂r en intern webbserver i DMZ vidarebefordras TCP/443 externt ‚Üí 192.0.2.20:443 (DNAT/port forwarding).

F√∂rtydligande (sammanfattning):

- SNAT/PAT: m√•nga interna ‚Üí en publik (utg√•ende).
- DNAT/Port forwarding: publik port ‚Üí intern tj√§nst.
- NAT ‚â† s√§kerhet: komplettera alltid med brandv√§ggspolicy.
- IPv6: normalt ingen NAT; anv√§nd brandv√§gg + segmentering.

SNAT/PAT: m√•nga interna ‚Üí en publik (utg√•ende).

DNAT/Port forwarding: publik port ‚Üí intern tj√§nst.

NAT ‚â† s√§kerhet: komplettera alltid med brandv√§ggspolicy.

IPv6: normalt ingen NAT; anv√§nd brandv√§gg + segmentering.

### 2.4.6 Vanliga till√§mpningar och fallgropar

NAT och DNS interagerar ofta med andra funktioner. Hairpin NAT beh√∂vs ibland om interna klienter ska n√• en intern tj√§nst via dess publika namn/IP. Double NAT (t.ex. operat√∂rs-router + egen brandv√§gg) komplicerar port√∂ppningar och fels√∂kning; CGNAT hos operat√∂ren kan om√∂jligg√∂ra inkommande portar. Vissa protokoll √§r k√§nsliga f√∂r NAT (t.ex. SIP, √§ldre FTP aktivt l√§ge), och kr√§ver antingen applikations-inspektion eller modernare l√§gen. I DHCP √§r fel VLAN, saknad relay eller fel scopes typiska orsaker till ‚Äúingen IP‚Äù. I DNS ger fel forwarders, split-horizon-missar eller f√∂r l√•ng TTL mystiska fel.

Exempel: Exempel: Elever kan n√• intranet.skolan.se fr√•n internet men inte fr√•n klassrummet. Orsak: hairpin NAT saknas ‚Äì DNAT g√§ller bara utifr√•n. L√∂sning: skapa intern policy och en ‚ÄúNAT loopback‚Äù-regel, eller l√§gg in intern A-post som pekar direkt p√• DMZ-IP.

F√∂rtydligande (sammanfattning):

- Hairpin NAT: kr√§vs f√∂r internt‚Üíinternt via publik IP.
- Double/CGNAT: kr√•nglar port√∂ppning och VPN.
- Protokoll: SIP/FTP m.fl. kan beh√∂va s√§rskild hantering.
- DHCP/DNS: fel VLAN/relay/TTL/forwarders = vanliga orsaker.

Hairpin NAT: kr√§vs f√∂r internt‚Üíinternt via publik IP.

Double/CGNAT: kr√•nglar port√∂ppning och VPN.

Protokoll: SIP/FTP m.fl. kan beh√∂va s√§rskild hantering.

DHCP/DNS: fel VLAN/relay/TTL/forwarders = vanliga orsaker.

### 2.4.7 Fels√∂kning: metodik och verktyg

B√∂rja n√§rmast klienten och g√• lager f√∂r lager. F√∂r DHCP: kolla l√§nklampa, r√§tt VLAN p√• porten, DHCP Snooping-loggar, och p√• klienten ipconfig /release /renew (Windows) eller dhclient -r; dhclient (Linux). F√∂r DNS: testa namnl√∂sning med nslookup/dig, kontrollera vilket namn som efterfr√•gas (CNAME-kedjor), och rensa cache (ipconfig /flushdns). F√∂r NAT: verifiera √∂vers√§ttningar med brandv√§ggens NAT-tabell, g√∂r paketf√•ngst p√• in- och utgr√§nssnitt och kontrollera brandv√§ggsregelns riktning. Vid m√§rkliga fel ‚Äì testa direkt med IP f√∂r att skilja DNS- fr√•n anslutningsproblem.

Exempel: Exempel: Klient n√•r IP 10.40.0.50 men inte files.skolan.local. nslookup visar att klienten fr√•gar 8.8.8.8 direkt (policy-avvikelse). √Ötg√§rd: tvinga klienter att anv√§nda skolans resolvers via DHCP option 6 och brandv√§ggsregler.

F√∂rtydligande (sammanfattning):

- DHCP: r√§tt VLAN/relay, lease/status p√• servern.
- DNS: nslookup/dig, TTL/cache, r√§tt resolver.
- NAT: kontrollera √∂vers√§ttningstabell, riktning, hairpin.
- Avgr√§nsa: testa med IP vs namn f√∂r att isolera felet.

DHCP: r√§tt VLAN/relay, lease/status p√• servern.

DNS: nslookup/dig, TTL/cache, r√§tt resolver.

NAT: kontrollera √∂vers√§ttningstabell, riktning, hairpin.

Avgr√§nsa: testa med IP vs namn f√∂r att isolera felet.

### 

### üìå Kontrollfr√•gor

- Beskriv DORA-processen och vad en lease inneb√§r.
- Varf√∂r anv√§nds DHCP relay och vilka s√§kerhets√•tg√§rder b√∂r aktiveras i accesslagret?
- Vilka DNS-poster √§r vanligast och vad anv√§nds de till?
- Vad √§r TTL och hur p√•verkar den b√•de prestanda och felr√§ttning?
- F√∂rklara skillnaden mellan SNAT/PAT och DNAT/port forwarding.
- Varf√∂r ska NAT inte ses som en s√§kerhetsmekanism i sig?
- N√§r beh√∂vs hairpin NAT och vilket alternativ finns i DNS?
- Ge exempel p√• hur split-horizon DNS anv√§nds i en skolmilj√∂.
- N√§mn tre vanliga orsaker till ‚Äúingen IP‚Äù i ett segmenterat n√§t.
- Vilka steg tar du f√∂r att skilja p√• DNS- och anslutningsproblem?

Beskriv DORA-processen och vad en lease inneb√§r.

Varf√∂r anv√§nds DHCP relay och vilka s√§kerhets√•tg√§rder b√∂r aktiveras i accesslagret?

Vilka DNS-poster √§r vanligast och vad anv√§nds de till?

Vad √§r TTL och hur p√•verkar den b√•de prestanda och felr√§ttning?

F√∂rklara skillnaden mellan SNAT/PAT och DNAT/port forwarding.

Varf√∂r ska NAT inte ses som en s√§kerhetsmekanism i sig?

N√§r beh√∂vs hairpin NAT och vilket alternativ finns i DNS?

Ge exempel p√• hur split-horizon DNS anv√§nds i en skolmilj√∂.

N√§mn tre vanliga orsaker till ‚Äúingen IP‚Äù i ett segmenterat n√§t.

Vilka steg tar du f√∂r att skilja p√• DNS- och anslutningsproblem?


### üîó F√∂rdjupningsl√§nkar

- RFC 2131 ‚Äì Dynamic Host Configuration Protocol: https://www.rfc-editor.org/rfc/rfc2131
- RFC 1034 ‚Äì Domain Names: Concepts and Facilities: https://www.rfc-editor.org/rfc/rfc1034
- RFC 1035 ‚Äì Domain Names: Implementation and Specification: https://www.rfc-editor.org/rfc/rfc1035
- RFC 1918 ‚Äì Address Allocation for Private Internets: https://www.rfc-editor.org/rfc/rfc1918
- RFC 4787 ‚Äì NAT Behavioral Requirements for Unicast UDP: https://www.rfc-editor.org/rfc/rfc4787
- RFC 6296 ‚Äì IPv6-to-IPv6 Network Prefix Translation (NPTv6): https://www.rfc-editor.org/rfc/rfc6296
- RFC 6146 ‚Äì Stateful NAT64: Network Address and Protocol Translation from IPv6 Clients to IPv4 Servers: https://www.rfc-editor.org/rfc/rfc6146
- RFC 6888 ‚Äì Common Requirements for Carrier-Grade NATs (CGN): https://www.rfc-editor.org/rfc/rfc6888

RFC 2131 ‚Äì Dynamic Host Configuration Protocol: https://www.rfc-editor.org/rfc/rfc2131

RFC 1034 ‚Äì Domain Names: Concepts and Facilities: https://www.rfc-editor.org/rfc/rfc1034

RFC 1035 ‚Äì Domain Names: Implementation and Specification: https://www.rfc-editor.org/rfc/rfc1035

RFC 1918 ‚Äì Address Allocation for Private Internets: https://www.rfc-editor.org/rfc/rfc1918

RFC 4787 ‚Äì NAT Behavioral Requirements for Unicast UDP: https://www.rfc-editor.org/rfc/rfc4787

RFC 6296 ‚Äì IPv6-to-IPv6 Network Prefix Translation (NPTv6): https://www.rfc-editor.org/rfc/rfc6296

RFC 6146 ‚Äì Stateful NAT64: Network Address and Protocol Translation from IPv6 Clients to IPv4 Servers: https://www.rfc-editor.org/rfc/rfc6146

RFC 6888 ‚Äì Common Requirements for Carrier-Grade NATs (CGN): https://www.rfc-editor.org/rfc/rfc6888


### ‚úçÔ∏è Egna anteckningar

‚Ä¶


