---
title: "5.2 Fördjupning: Windows Server och GPO"
parent: "Nätverk"
nav_order: 502
---

# 5.2 Fördjupning: Windows Server och GPO

### 5.2.1 Vad är GPO – och var börjar man?
Tänk Group Policy (GPO) som en central regibok för Windows-klienter och -servrar. Du beskriver hur datorer och användarsessioner ska se ut och bete sig, och domänen ser till att det händer — automatiskt och konsekvent. Det kan vara allt från skrivbordsdetaljer och genvägar till säkerhet, kryptering, brandvägg, programvaror och uppdateringar. Vitsen är förutsägbarhet, spårbarhet och fart: samma in, samma ut, utan handpåläggning på varje maskin.
Du arbetar i Group Policy Management Console (GPMC). Där ser du skog → domän → Group Policy Objects (själva “dokumenten”) och OU:er (behållare där du länkar dem). Öppnar du en GPO möts du av två huvuddelar:
- Computer Configuration (gäller datorn oavsett vem som loggar in).
- User Configuration (gäller användarsessionen på den datorn).
Computer Configuration (gäller datorn oavsett vem som loggar in).
User Configuration (gäller användarsessionen på den datorn).
En bra start är att skapa en enkel GPO (t.ex. standardbakgrund), länka den till en test-OU och se hur inställningen rullar ut. För att alla admins ska se samma policyspråk och versioner lägger man administrativa mallar (ADMX/ADML) i en Central Store i SYSVOL. Då blir det lättare att samarbeta och undvika “det såg inte ut så på min dator”.
Exempel: Skapa “GPO-Desktop-Standard”. Sätt ett neutralt skrivbordsunderlägg och dölja vissa kontrollpaneler. Länka till en test-OU med några datorer. Vid nästa uppdatering får användarna samma skrivbordsmiljö — inga manuella klick.
### 5.2.2 Hierarki och utvärdering – vem “vinner” när policies krockar?
Windows tillämpar policy i ordningen Lokal → Site → Domain → OU (L-S-D-O-U). Varje steg kan lägga till eller skriva över inställningar. I en och samma behållare styr även Link Order: länken som ligger sist kör sist — och vinner vid krock.
Två “brytare” påverkar arvet:
- Enforced (No override): tvingar igenom en länkad GPO nedåt även om någon längre ner försöker skriva över den.
- Block Inheritance: stoppar arv från ovan — men Enforced går igenom ändå.
Enforced (No override): tvingar igenom en länkad GPO nedåt även om någon längre ner försöker skriva över den.
Block Inheritance: stoppar arv från ovan — men Enforced går igenom ändå.
Särfallet Loopback Processing gör att användarinställningar kan tas från datorns OU. Det är ovärderligt för delade maskiner, kiosker och VDI.
- Merge: användarpolicyn kombineras; datorns OU kan överstyra detaljer.
- Replace: användarpolicyn kommer enbart från datorns OU.
Merge: användarpolicyn kombineras; datorns OU kan överstyra detaljer.
Replace: användarpolicyn kommer enbart från datorns OU.
Exempel: En domänlänkad GPO “Säkerhetsbas” sätter standardregler. I en viss server-OU finns “RDP-Tilldelning”. Om de krockar vinner OU-länken — om inte “Säkerhetsbas” är Enforced.
Bakgrundsnot: Klienter uppdaterar i bakgrunden med jämna mellanrum. Viss funktionalitet (t.ex. programvaruinstallation) sker dock vid start/inloggning. gpupdate /force triggar en omedelbar uppdatering, men kräver ibland omstart för att allt ska slå igenom.
### 5.2.3 Från lätt till tungt – vad kan du styra med GPO?
Börja med det synliga — det ger snabb bekräftelse på att kopplingar och arv fungerar — och bygg sedan upp mot säkerhet och drift.
- Administrative Templates: färdiga policyer som i grunden skriver välkända registernycklar. Exempel: skrivbordsunderlägg, kontrollpaneler, webbläsarpolicyer, Onedrive/Office-inställningar.
- Group Policy Preferences (GPP): lägger till filer, mappar, genvägar, drivmappar och skrivare. Med Item-Level Targeting kan du villkora per grupp, OU, OS-version, plats, IP-område, datornamn m.m. Resultatet blir samma precision som skript — men mer robust.
- Security Filtering: låt bara en viss säkerhetsgrupp påverkas av GPO:t.
- WMI-filter: träffa t.ex. bara klient-OS, eller bara bärbara (har batteri). Använd sparsamt — många eller tunga filter ökar inloggningstid.
Administrative Templates: färdiga policyer som i grunden skriver välkända registernycklar. Exempel: skrivbordsunderlägg, kontrollpaneler, webbläsarpolicyer, Onedrive/Office-inställningar.
Group Policy Preferences (GPP): lägger till filer, mappar, genvägar, drivmappar och skrivare. Med Item-Level Targeting kan du villkora per grupp, OU, OS-version, plats, IP-område, datornamn m.m. Resultatet blir samma precision som skript — men mer robust.
Security Filtering: låt bara en viss säkerhetsgrupp påverkas av GPO:t.
WMI-filter: träffa t.ex. bara klient-OS, eller bara bärbara (har batteri). Använd sparsamt — många eller tunga filter ökar inloggningstid.
Exempel: En GPP-drivmapp syns bara för gruppen “Ekonomi” och endast på datorer i “OU=Ekonomi”. Ingen annan påverkas, även om GPO:t är länkat högre upp.
### 5.2.4 Skript via GPO – när är Startup/Logon rätt, och när är Schemalagd uppgift bättre?
Startup/Shutdown körs i dator-kontekst (före/efter inloggning) som Local System. Perfekt för maskinnära saker: registry, tjänster, protokoll, filkopior som kräver admin.Logon/Logoff körs i användarsession och passar profilnära uppgifter: genvägar, små städjobb, användar-specifika registerjusteringar.
Vill du ha retry, fördröjning, villkor, tidsgränser och bättre loggning använder du Scheduled Tasks via GPP. Kör som SYSTEM eller tjänstkonto, trigga “At startup”, “At logon” eller vid schema. Lägg skript i SYSVOL (gemensamt, versionsstyrt) och styr Execution Policy/kodsignering i GPO. Tänk på att nätverksresurser kanske inte finns tillgängliga precis i uppstart — vill du garantera det aktiverar du policyn Always wait for the network at computer startup and logon i en bas-GPO.
Exempel: Ett Startup-skript stänger av SMBv1 och sätter NTP-källa. En Schemalagd uppgift (SYSTEM) kör varje natt och rensar temporära mappar; resultatet loggas i Event Viewer.
Litet skript-exempel (Startup, körs som SYSTEM)Exempel: Lägg i \\<domän>\SYSVOL\<domän>\Scripts\Startup\Hardening.ps1 och kör via Computer Configuration → Policies → Windows Settings → Scripts (Startup/Shutdown) eller som Scheduled Task (At startup).
# Hardening.ps1 - körs som Local System vid startup
# 1) Stäng av SMBv1 (klientkomponent)
Try { Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -NoRestart -ErrorAction Stop } Catch { }
# 2) Stäng av SMBv1 (serversidan)
Try { Set-SmbServerConfiguration -EnableSMB1Protocol $false -Force } Catch { }
# 3) Sätt NTP-källa (ersätt med er tidskälla)
$ntp = 'time.example.org,0x8'
w32tm /config /syncfromflags:manual /manualpeerlist:$ntp /update | Out-Null
w32tm /resync /force | Out-Null
# 4) Logga enkel status
$msg = "Hardening klar: SMBv1 avstängd, NTP=$ntp"
Write-EventLog -LogName Application -Source "Windows PowerShell" -EntryType Information -EventId 1001 -Message $msg
### 5.2.5 Programvarudistribution – strategier, val och fallgropar
Utmaningen: Program kommer som MSI, EXE eller MSIX. De har olika tysta switchar, kräver olika detektion (hur vet vi att appen redan finns?), har beroenden (drivrutiner, VC++-omfördelningsbara), och vissa kräver omstart. En bra strategi ger: spårbarhet (loggar/status), piloter (testgrupper), ringar (stegvis utrullning) och rollback.
A) GPO + MSI (enkelt och stabilt)Med Software Installation i GPO kan du Assign to Computer ett MSI. Installationen sker vid start, innan inloggning, vilket är robust. Lägg källan på UNC-share med läsrätt för datorer. Anpassa via MST (transform). Begränsningar: främst MSI, svagt för EXE, enkel rapportering.
B) GPO + skript/GPP (för EXE och specialfall)Kör EXE med tyst flagga (/quiet, /S, /VERYSILENT) via Startup-skript eller Scheduled Task (SYSTEM). Bygg in detektion (kontrollera fil/reg-nyckel, kör inte igen om det redan finns) och logga exit-koder. Bra för mindre/medel miljö — men standardisera loggformat, uninstall och rollback.
C) Intune (MDM) – ringar, självbetjäning och internetnoderPaketering till .intunewin, definiera install/uninstall-kommandon, detektionsregler och beroenden. Kör mot användare eller enheter, gör Required (tvingad) eller Available i portal. Styrka: ringar, självbetjäning, funkar utanför LAN.
D) Configuration Manager (SCCM/MECM) – djup kontroll on-premFull kontroll över applikationer, samlingar, phased deployments, detaljerad status och rapporter. Passar större on-prem-miljöer med höga krav på precision och uppföljning.
Gemensamma råd:
- Ha en paketstandard (katalognamn, logg, detektion, uninstall).
- Skilj installationskonto från detektionslogik; detection ska vara snabb och pålitlig.
- Undvik “eviga” installationsförsök genom att bryta på tydliga exit-koder.
- Planera omstarter (t.ex. via deadlines eller nattfönster).
- Kör pilot först; utvärdera innan du breddar.
Ha en paketstandard (katalognamn, logg, detektion, uninstall).
Skilj installationskonto från detektionslogik; detection ska vara snabb och pålitlig.
Undvik “eviga” installationsförsök genom att bryta på tydliga exit-koder.
Planera omstarter (t.ex. via deadlines eller nattfönster).
Kör pilot först; utvärdera innan du breddar.
Hands-on: MSI via GPO (Assigned to Computer)
- Lägg App.msi (ev. App.mst) på \\fileserver\software\App\ och ge Read för Domain Computers.
- Skapa GPO “GPO-Apps-App”.
- Öppna GPO → Computer Configuration → Policies → Software Settings → Software Installation → New → Package… → peka på UNC → Assigned.
- (Valfritt) Lägg App.mst under Modifications.
- Länka GPO:t till mål-OU (datorer).
- Sätt Always wait for the network at computer startup and logon = Enabled i bas-GPO.
- Testa: gpupdate /force, omstart, verifiera i loggar/Program och funktioner.
- Uppgradera via Upgrades-fliken, eller ta bort med Remove (ev. Immediately uninstall).
Lägg App.msi (ev. App.mst) på \\fileserver\software\App\ och ge Read för Domain Computers.
Skapa GPO “GPO-Apps-App”.
Öppna GPO → Computer Configuration → Policies → Software Settings → Software Installation → New → Package… → peka på UNC → Assigned.
(Valfritt) Lägg App.mst under Modifications.
Länka GPO:t till mål-OU (datorer).
Sätt Always wait for the network at computer startup and logon = Enabled i bas-GPO.
Testa: gpupdate /force, omstart, verifiera i loggar/Program och funktioner.
Uppgradera via Upgrades-fliken, eller ta bort med Remove (ev. Immediately uninstall).
Exempel: “GPO-Apps-Reader” installerar Adobe Reader tyst från \\fileserver\software\Reader\AcroRead.msi, med AcroRead.mst för språk och avstängd auto-update.
### 5.2.6 Centrala uppdateringar – WUfB, WSUS och ringar
Målet är att få en trygg rytm: små säkra steg ofta, och stora steg när du är redo — med ringar som fångar fel tidigt.
- Windows Update for Business (WUfB): Klienter hämtar från Microsoft Update, men du styr deferral (hur länge de väntar), deadlines (när de måste installera/boota) och ringar (Pilot → Bred → Sen). Fungerar utmärkt för enheter som inte alltid är på LAN.
- WSUS: Du godkänner uppdateringar centralt och styr vilka datorgrupper som får vad — när. Bra när du behöver lokal cache, strikt kontroll eller avskilda nät.
Windows Update for Business (WUfB): Klienter hämtar från Microsoft Update, men du styr deferral (hur länge de väntar), deadlines (när de måste installera/boota) och ringar (Pilot → Bred → Sen). Fungerar utmärkt för enheter som inte alltid är på LAN.
WSUS: Du godkänner uppdateringar centralt och styr vilka datorgrupper som får vad — när. Bra när du behöver lokal cache, strikt kontroll eller avskilda nät.
Tänk i två flöden:
- Quality Updates (månatliga säkerhetsfixar): rulla snabbt genom ringar med kort deferral.
- Feature Updates (större OS-lyft): längre deferral och tydligare pilot.
Quality Updates (månatliga säkerhetsfixar): rulla snabbt genom ringar med kort deferral.
Feature Updates (större OS-lyft): längre deferral och tydligare pilot.
Glöm inte Delivery Optimization så klienter delar paket i LAN; det sparar internetkapacitet. Bestäm hur du hanterar drivrutiner, .NET och Microsoft 365 Apps (de kan ha egna kanaler).
Hands-on: WUfB ring-setup (Pilot → Bred → Sen)A. Grupper och GPO:n
- Skapa tre säkerhetsgrupper: WUfB-Pilot, WUfB-Bred, WUfB-Sen.
- Skapa tre GPO:n: “WUfB-Pilot”, “WUfB-Bred”, “WUfB-Sen”. Länka dem högt upp, men låt Security Filtering styra att rätt grupp får rätt GPO.
Skapa tre säkerhetsgrupper: WUfB-Pilot, WUfB-Bred, WUfB-Sen.
Skapa tre GPO:n: “WUfB-Pilot”, “WUfB-Bred”, “WUfB-Sen”. Länka dem högt upp, men låt Security Filtering styra att rätt grupp får rätt GPO.
B. Policys (Computer Configuration → Administrative Templates → Windows Update)
- Select when Feature Updates are received = Enabled → Deferral days: Pilot 0, Bred 7–14, Sen 21–28.
- Select when Quality Updates are received = Enabled → Deferral days: Pilot 0, Bred 2–7, Sen 10–14.
- Specify deadlines for automatic updates and restarts = Enabled (sätt rimliga deadlines och grace).
- Configure Automatic Updates = Enabled (auto-nedladdning och schemalagd install).
- Delivery Optimization: sätt läge för LAN-delning.
- Har ni haft WSUS tidigare? Säkerställ att intranät-WSUS inte längre pekas ut i dessa GPO:n (WUfB och WSUS samtidigt skapar konflikt).
Select when Feature Updates are received = Enabled → Deferral days: Pilot 0, Bred 7–14, Sen 21–28.
Select when Quality Updates are received = Enabled → Deferral days: Pilot 0, Bred 2–7, Sen 10–14.
Specify deadlines for automatic updates and restarts = Enabled (sätt rimliga deadlines och grace).
Configure Automatic Updates = Enabled (auto-nedladdning och schemalagd install).
Delivery Optimization: sätt läge för LAN-delning.
Har ni haft WSUS tidigare? Säkerställ att intranät-WSUS inte längre pekas ut i dessa GPO:n (WUfB och WSUS samtidigt skapar konflikt).
C. Rulla
- gpupdate /force på Pilotenheter. Kontrollera att inställningarna syns på Windows Update-sidan.
- Följ upp status med dina verktyg (oavsett om det är Intune, SCCM eller egen inventering).
- När piloten är grön: flytta fler enheter in i Bred. Upprepa mot Sen.
gpupdate /force på Pilotenheter. Kontrollera att inställningarna syns på Windows Update-sidan.
Följ upp status med dina verktyg (oavsett om det är Intune, SCCM eller egen inventering).
När piloten är grön: flytta fler enheter in i Bred. Upprepa mot Sen.
Exempel: Pilot har 0 dagars deferral och 7 dagars deadline. Bred har 14/14. Sen har 28/21. Om något fallerar i Piloten pausar du ringen eller höjer deferral i Bred/Sen tills fix finns.
### 5.2.7 Felsökning – se vad som faktiskt gäller
Börja alltid med vad klienten tror är sant:
- gpresult /h rapport.html visar vilka GPO:er som tillämpats (för dator och användare), vilka som filtrerats bort (säkerhet/WMI) och varför.
- RSOP.msc ger en snabb översikt av “Resultant Set of Policy”.
- Event Viewer → Microsoft → Windows → GroupPolicy/Operational avslöjar timing och fel.
- I GPMC kan du modellera förväntat utfall (vilka GPO som bör gälla) och jämföra med Results från en faktisk dator.
gpresult /h rapport.html visar vilka GPO:er som tillämpats (för dator och användare), vilka som filtrerats bort (säkerhet/WMI) och varför.
RSOP.msc ger en snabb översikt av “Resultant Set of Policy”.
Event Viewer → Microsoft → Windows → GroupPolicy/Operational avslöjar timing och fel.
I GPMC kan du modellera förväntat utfall (vilka GPO som bör gälla) och jämföra med Results från en faktisk dator.
Vanliga bovar:
- Fel OU/ingen länk → klienten nås inte av GPO:t.
- Security Filtering träffar inte datorn/användaren.
- WMI-filter för snävt eller långsamt.
- Nätverk inte klart vid boot → programvaruinstall missar (aktivera “Always wait for the network…”).
- AD-replikering släpar → testa på DC där klienten hämtar policy.
- SYSVOL-behörigheter/delningsproblem → MSI-källa når inte fram.
Fel OU/ingen länk → klienten nås inte av GPO:t.
Security Filtering träffar inte datorn/användaren.
WMI-filter för snävt eller långsamt.
Nätverk inte klart vid boot → programvaruinstall missar (aktivera “Always wait for the network…”).
AD-replikering släpar → testa på DC där klienten hämtar policy.
SYSVOL-behörigheter/delningsproblem → MSI-källa når inte fram.
Exempel: En skrivare mappas inte. gpresult visar att GPO:t filtrerats bort av ett WMI-filter för “Bärbar”. Datorn är stationär. Lösning: flytta villkoret till Item-Level Targeting (OU/grupp) eller justera WMI-villkoret.
### 📌 Kontrollfrågor
- Vad vinner du på att styra Windows via GPO istället för att manuellt konfigurera varje maskin?
- Förklara L-S-D-O-U och hur Enforced respektive Block Inheritance påverkar utfallet.
- När väljer du Loopback (Merge/Replace) och hur påverkar det användarpolicyn?
- Ge ett exempel där du kombinerar Administrative Templates, GPP och Item-Level Targeting.
- När är Startup/Logon-skript rätt val, och när är Scheduled Task via GPP bättre?
- Beskriv ett komplett MSI via GPO-flöde och hur du planerar uppgradering/rollback.
- Hur hanterar du EXE-appar centralt med detektion och loggning — utan tredjepartsverktyg?
- Vad skiljer WUfB från WSUS, och när väljer du det ena framför det andra?
- Hur designar du ringar (Pilot → Bred → Sen) för både Quality och Feature Updates?
- Bygg en enkel felsökningskedja när ett GPO inte tillämpas (vilka verktyg, i vilken ordning, och varför).
Vad vinner du på att styra Windows via GPO istället för att manuellt konfigurera varje maskin?
Förklara L-S-D-O-U och hur Enforced respektive Block Inheritance påverkar utfallet.
När väljer du Loopback (Merge/Replace) och hur påverkar det användarpolicyn?
Ge ett exempel där du kombinerar Administrative Templates, GPP och Item-Level Targeting.
När är Startup/Logon-skript rätt val, och när är Scheduled Task via GPP bättre?
Beskriv ett komplett MSI via GPO-flöde och hur du planerar uppgradering/rollback.
Hur hanterar du EXE-appar centralt med detektion och loggning — utan tredjepartsverktyg?
Vad skiljer WUfB från WSUS, och när väljer du det ena framför det andra?
Hur designar du ringar (Pilot → Bred → Sen) för både Quality och Feature Updates?
Bygg en enkel felsökningskedja när ett GPO inte tillämpas (vilka verktyg, i vilken ordning, och varför).
### 🔗 Fördjupningslänkar
- Group Policy – översikt: https://learn.microsoft.com/windows-server/identity/ad-ds/manage/group-policy/group-policy-overview
- Group Policy processing (LSDOU, Enforced/Block): https://learn.microsoft.com/windows-server/identity/ad-ds/manage/group-policy/group-policy-processing
- Loopback processing: https://learn.microsoft.com/troubleshoot/windows-server/group-policy/loopback-processing-of-group-policy
- Group Policy Preferences & Item-Level Targeting: https://learn.microsoft.com/windows-server/identity/ad-ds/manage/group-policy/group-policy-preferences
- WMI-filter – skapa och använda: https://learn.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj717288(v=ws.11)
- Installera program via GPO (MSI): https://learn.microsoft.com/troubleshoot/windows-server/group-policy/use-group-policy-to-install-software
- Intune – Win32 app management: https://learn.microsoft.com/intune/intune-service/apps/apps-win32-app-management
- Windows Update for Business – konfigurera: https://learn.microsoft.com/windows/deployment/update/waas-configure-wufb
- WSUS – kom igång: https://learn.microsoft.com/windows-server/administration/windows-server-update-services/get-started/windows-server-update-services-wsus
- gpresult – visa effektiv policy: https://learn.microsoft.com/windows-server/administration/windows-commands/gpresult
- Central Store för ADMX/ADML: https://learn.microsoft.com/troubleshoot/windows-client/group-policy/create-and-manage-central-store
Group Policy – översikt: https://learn.microsoft.com/windows-server/identity/ad-ds/manage/group-policy/group-policy-overview
Group Policy processing (LSDOU, Enforced/Block): https://learn.microsoft.com/windows-server/identity/ad-ds/manage/group-policy/group-policy-processing
Loopback processing: https://learn.microsoft.com/troubleshoot/windows-server/group-policy/loopback-processing-of-group-policy
Group Policy Preferences & Item-Level Targeting: https://learn.microsoft.com/windows-server/identity/ad-ds/manage/group-policy/group-policy-preferences
WMI-filter – skapa och använda: https://learn.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj717288(v=ws.11)
Installera program via GPO (MSI): https://learn.microsoft.com/troubleshoot/windows-server/group-policy/use-group-policy-to-install-software
Intune – Win32 app management: https://learn.microsoft.com/intune/intune-service/apps/apps-win32-app-management
Windows Update for Business – konfigurera: https://learn.microsoft.com/windows/deployment/update/waas-configure-wufb
WSUS – kom igång: https://learn.microsoft.com/windows-server/administration/windows-server-update-services/get-started/windows-server-update-services-wsus
gpresult – visa effektiv policy: https://learn.microsoft.com/windows-server/administration/windows-commands/gpresult
Central Store för ADMX/ADML: https://learn.microsoft.com/troubleshoot/windows-client/group-policy/create-and-manage-central-store
### ✍️ Egna anteckningar
…