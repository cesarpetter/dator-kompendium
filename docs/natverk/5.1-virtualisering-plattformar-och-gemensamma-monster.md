# 5. Fördjupningsdel

## 5.1 Virtualisering – plattformar och gemensamma mönster

### 5.1.1 Varför virtualisera? (problembakgrund och mål)

Virtualisering blev standard därför att den löser flera problem samtidigt: hårdvaran utnyttjas bättre (fler servrar per fysisk värd), isolation mellan tjänster ökar driftsäkerheten, snabb återställning blir möjlig med snapshots/kloner/backup, och automation (skript, mallar, “infrastruktur som kod”) gör att du kan bygga och återskapa miljöer på minuter istället för dagar. För skola och SMB betyder det att labbar och skarp drift kan leva sida vid sida, att uppgraderingar testas innan de rullas ut, och att enskilda fel inte behöver ta ner hela miljön. Virtualisering förenklar också disaster recovery – när servrar är filer/diskavbilder kan de flyttas och startas på annan hårdvara.

Vanliga drivkrafter: konsolidering och kostnad, snabb provisionering, enklare DR/backup, bättre säkerhetszonering, samt möjligheten att skala och ändra utan att byta fysisk hårdvara varje gång.

Exempel (Exempel:*) Inför nationella prov körs en separat provtjänst i egen VM. Efter provperioden tas en snapshot för arkiv, och resurserna (CPU/RAM) återgår till ordinarie drift.

### 5.1.2 Gemensam arkitektur (oavsett plattform)

Alla moderna plattformar delar samma byggstenar: hypervisor (kärnan som kör VM:er), virtuella switchar/bridges som kopplar VM:er mot nätet, lagring (lokal eller delad), och hantering (webb-UI/CLI/API). Du arbetar med mallar (golden images), nätprofiler (VLAN/portgrupper), samt policies för resurser och säkerhet. Två viktiga principer:

- Snapshots ≠ backup (snapshot är kortlivad säkerhetslina; backup är separata, helst immutabla/air-gappade kopior).
- Segmentera trafik: management, lagring, backup och produktion i egna VLAN/subnät och med tydliga brandväggsregler.

Snapshots ≠ backup (snapshot är kortlivad säkerhetslina; backup är separata, helst immutabla/air-gappade kopior).

Segmentera trafik: management, lagring, backup och produktion i egna VLAN/subnät och med tydliga brandväggsregler.

Exempel (Exempel:*) Management-VLAN nås bara via bastion/jump host; backupflöden går i separat VLAN så att en överbelastad applikationslänk inte stör backupfönstret.

### 5.1.3 Plattformerna (bakgrund, styrkor och begränsningar)

Proxmox VE (KVM/QEMU + LXC, Debianbaserad)
Proxmox bygger på Debian Linux och använder KVM/QEMU för fullvirtualisering (bra för Windows Server) samt LXC för lätta Linux-containrar. Styrkorna är öppen källkod, snabb utveckling, VLAN-aware Linux bridges, ZFS-stöd, klusterhantering och Proxmox Backup Server (dedupe, verifiering, immutability-policy). Passar skolor/labbar/SMB som vill ha kraftfullt och kostnadseffektivt utan licenslåsning. Begränsningar: kräver Linux-vana, färre “färdigpaketerade” enterprise-ekosystem än vSphere.

VMware vSphere/ESXi (proprietär standard i många företag)
vSphere består av ESXi (hypervisor) och vCenter (central hantering). Styrkorna är mogen drift, enormt ekosystem (backup, övervakning), vMotion/DRS (liveflytt/lastbalansering) och Distributed vSwitch. Lämpligt när du behöver beprövad, stor skala och certifierat stöd från många leverantörer. Begränsningar: licenskostnad, beroende av VMware-ekosystemet; avancerade funktioner kräver rätt edition.

Microsoft Hyper-V (Windowsintegrerad hypervisor)
Hyper-V är integrerad i Windows Server (roll) och har virtual switch, VHDX, Checkpoints och bra PowerShell-stöd. Styrkor: tajt integration med Windows, AD/GPO, SMB3/Storage Spaces, och gott stöd i många backupverktyg. Lämpligt om ni redan är “Windows-tunga” och vill hålla verktygen enhetliga. Begränsningar: mindre ekosystem för Linux-containers, vissa funktioner kräver Datacenter-licens; Microsofts fristående Hyper-V Server är utfasad (fokuset ligger på Windows Server-rollen).

XCP-ng (Xen-baserad, öppen)
XCP-ng bygger på Xen och erbjuder enterprise-känsla i open-source-tappning, med Xen Orchestra för hantering/backup (GUI/SaaS eller self-hosted). Styrkor: bra balans mellan enkelhet och kapacitet, stabil hypervisor, vettiga snapshot/backupflöden, och aktiv community. Begränsningar: färre “plug-and-play”-integrationer än VMware, viss inlärningskurva kring Xen-terminologi.

libvirt/KVM “ren” (t.ex. virt-manager/terraform-libvirt)
Det “rena” KVM/libvirt-spåret ger maximal kontroll (nära Linux), med bridge/OVS, cloud-init, och automation via Ansible/Terraform. Styrkor: full transparens, inga licenser, perfekt för djup Linuxlabb. Begränsningar: kräver mest Linux-kompetens; färre bekvämligheter out-of-the-box för större team.

Exempel (Exempel:*) En kommunal IT-avdelning med Windows-tyngd kör Hyper-V för skarp drift (AD, fil, print) men använder Proxmox för kurslabb och snabb prototypning. En partner kör vSphere för “tunga” produktionstjänster med höga SLA, och XCP-ng på filialkontor.

### 5.1.4 Nätmönster: bridge, trunk, VLAN och NAT

Oavsett plattform möter du tre mönster:
Bridge till produktion (VLAN-aware): uplink som trunk från switchen; skapa portgrupp/bridge som bär flera VLAN och tilldela VLAN-ID per VM-interface.
Isolerat NAT-nät för labb: en virtuell switch/bridge med NAT mot värden eller särskild edge-VM; perfekt för att låta elever labba utan att röra produktion.
Dedikerad management/backup/storage-väg: separata nät för admin, backup och lagring (t.ex. iSCSI/NFS) för prestanda/säkerhet.

Exempel (Exempel:*) En webb-VM i DMZ får vNIC på VLAN 70; brandvägg släpper endast 80/443 in och 443 till intern API-server. En andra vNIC på VLAN 99 används enbart för backupflöden till backupservern.

### 5.1.5 Lagring, snapshots och backup

Snapshots fryser VM-disk (och ev. minne) på primär lagring; de är perfekta inför ändringar men ska rensas efter test. Backup skapar en separerad kopia (helst immutabel och/eller air-gappad) som inte påverkas om primär lagring skadas eller krypteras.
Proxmox + Proxmox Backup Server ger dedupe/komprimering/verifiering. vSphere har stort stöd i verktyg som Veeam. Hyper-V fungerar med VSS och Windows-/tredjepartsbackup. XCP-ng har XO/XOA-backup. Libvirt/KVM kan använda borg/restic/rsync-strategier och “agent-i-gäst” för app-konsistens.

Exempel (Exempel:*) Inför patch: snapshot → patch → test → rensa snapshot; ordinarie nattbackup (full + inkrementell) fortsätter och restore-test körs varje månad i isolerat VLAN.

### 5.1.6 Hög tillgänglighet, kluster och DR

Kluster låter dig hantera flera noder som en enhet (gemensam vy, policyer). Live migration flyttar VM utan avbrott vid underhåll. HA startar automatiskt om VM:er på annan nod vid fel. För DR (större avbrott) behövs replikerad backup, dokumenterad återstartsordning (Tier 0→1→2) och regelbundna spärrtester (se kapitel 4.4).

Exempel: Kvällsunderhåll: vMotion/Live Migration flyttar VM bort från noden som ska patchas. Under driftfel startar HA upp kritiska VM på frisk nod; användarna märker en kort paus.

### 5.1.7 Resurser och licenser (CPU, RAM, disk, Windows Server)

Allokera resurser konservativt först och mät. Overcommit kan fungera för CPU men var försiktig med RAM och I/O-tunga diskar. Planera nätprofiler (vNIC-antal/roller) och håll dig till namngivning/mallar för spårbarhet.
Tänk även på licenser: Windows Server Datacenter ger rätt att köra obegränsat antal Windows-VM:er på licensierad hårdvara; Standard ger rätt för ett mindre antal VM:er per licens. Detta kan styra var du placerar Windows-tunga arbetslaster.

Exempel: Filserver-VM: 2 vCPU, 8–12 GB RAM (6–8 GB garanterat), virtio-SCSI + iothread, två vNIC (produktion/backup). Justera efter mätvärden i övervakningen.

### 5.1.8 Säkerhet och driftetikett

Separera management från produktion, använd MFA och bastion/jump host för adminåtkomst, och logga alla förändringar. Håll brandväggspolicy mellan VLAN/zoner även i labb. Vid WLAN-anslutna klienter som når VM-miljön: säkerställ rollbaserade brandväggsregler och övervaka ovanliga flöden.

Exempel: Admin når hypervisorer via VPN → bastion i management-VLAN → SSH/RDP vidare till värdar/VM. Inga öppna adminportar mot internet.

### 

### 5.1.9 Jämförelsetabell (styrkor, när använda, begränsningar)

Proxmox (Debian)

- Nätmodell (VLAN/NAT): Linux bridge (VLAN-aware), trunk på uplink, NAT-bridge för labb, bond/LACP.
- HA/Live migration: Kluster med Proxmox HA; live migration (delad lagring eller replikering).
- Backup-ekosystem: Proxmox Backup Server (dedupe, verifiering, immutability-policy) + 3:e-partsverktyg via standardprotokoll.
- Styrkor: Öppen källkod, kostnadseffektiv, LXC + KVM, ZFS-stöd, starkt API/community.
- Begränsningar: Kräver mer Linuxvana; färre “stora” certifierade integrationer än vSphere.
- Lämplighet: Skola/SMB/labb; mixad Win/Linux; där budget, flexibilitet och transparens väger tungt.

Nätmodell (VLAN/NAT): Linux bridge (VLAN-aware), trunk på uplink, NAT-bridge för labb, bond/LACP.

HA/Live migration: Kluster med Proxmox HA; live migration (delad lagring eller replikering).

Backup-ekosystem: Proxmox Backup Server (dedupe, verifiering, immutability-policy) + 3:e-partsverktyg via standardprotokoll.

Styrkor: Öppen källkod, kostnadseffektiv, LXC + KVM, ZFS-stöd, starkt API/community.

Begränsningar: Kräver mer Linuxvana; färre “stora” certifierade integrationer än vSphere.

Lämplighet: Skola/SMB/labb; mixad Win/Linux; där budget, flexibilitet och transparens väger tungt.

VMware vSphere/ESXi

- Nätmodell (VLAN/NAT): vSwitch/Distributed vSwitch, port groups (VLAN-ID), NAT via Edge-/gateway-VM eller NSX.
- HA/Live migration: Mycket moget: vMotion/Storage vMotion/DRS/HA.
- Backup-ekosystem: Stort (VADP-stöd); Veeam m.fl. med bred funktionalitet.
- Styrkor: Mognad, skala, brett ekosystem, leverantörsstöd/certifieringar.
- Begränsningar: Licenskostnader och editioner; viss inlåsning i ekosystemet.
- Lämplighet: Större/kritiska miljöer med hårda SLA och krav på certifierade integrationer.

Nätmodell (VLAN/NAT): vSwitch/Distributed vSwitch, port groups (VLAN-ID), NAT via Edge-/gateway-VM eller NSX.

HA/Live migration: Mycket moget: vMotion/Storage vMotion/DRS/HA.

Backup-ekosystem: Stort (VADP-stöd); Veeam m.fl. med bred funktionalitet.

Styrkor: Mognad, skala, brett ekosystem, leverantörsstöd/certifieringar.

Begränsningar: Licenskostnader och editioner; viss inlåsning i ekosystemet.

Lämplighet: Större/kritiska miljöer med hårda SLA och krav på certifierade integrationer.

Microsoft Hyper-V (Windows)

- Nätmodell (VLAN/NAT): Virtual Switch med VLAN-ID, NIC Teaming; NAT via RRAS/Windows NAT eller gateway-VM.
- HA/Live migration: Failover Clustering, Live/Storage Migration.
- Backup-ekosystem: VSS-integration; Windows Server Backup, Veeam m.fl.
- Styrkor: Tajt Windows/AD-integration, PowerShell/automation, låg tröskel i MS-miljö.
- Begränsningar: Vissa funktioner kräver Datacenter-licens; mindre fokus på Linux/containers; fristående Hyper-V Server utfasad.
- Lämplighet: Windows-tung drift (AD, fil/print, RDS); skolor/organisationer med MS-stack.

Nätmodell (VLAN/NAT): Virtual Switch med VLAN-ID, NIC Teaming; NAT via RRAS/Windows NAT eller gateway-VM.

HA/Live migration: Failover Clustering, Live/Storage Migration.

Backup-ekosystem: VSS-integration; Windows Server Backup, Veeam m.fl.

Styrkor: Tajt Windows/AD-integration, PowerShell/automation, låg tröskel i MS-miljö.

Begränsningar: Vissa funktioner kräver Datacenter-licens; mindre fokus på Linux/containers; fristående Hyper-V Server utfasad.

Lämplighet: Windows-tung drift (AD, fil/print, RDS); skolor/organisationer med MS-stack.

XCP-ng (Xen)

- Nätmodell (VLAN/NAT): Networks med VLAN-taggning; NAT via gateway-VM (t.ex. OPNsense).
- HA/Live migration: Live migration/HA med delad lagring; orkestreras via Xen Orchestra (XO/XOA).
- Backup-ekosystem: Inbyggt i XO/XOA (delta, replikering) + 3:e-partsverktyg.
- Styrkor: Open source med “enterprise-känsla”, enkel drift, bra GUI (XO).
- Begränsningar: Mindre ekosystem än VMware; vissa features beroende av XO.
- Lämplighet: Filial/SMB; behov av HA/backup utan stora licenskostnader.

Nätmodell (VLAN/NAT): Networks med VLAN-taggning; NAT via gateway-VM (t.ex. OPNsense).

HA/Live migration: Live migration/HA med delad lagring; orkestreras via Xen Orchestra (XO/XOA).

Backup-ekosystem: Inbyggt i XO/XOA (delta, replikering) + 3:e-partsverktyg.

Styrkor: Open source med “enterprise-känsla”, enkel drift, bra GUI (XO).

Begränsningar: Mindre ekosystem än VMware; vissa features beroende av XO.

Lämplighet: Filial/SMB; behov av HA/backup utan stora licenskostnader.

libvirt/KVM “ren”

- Nätmodell (VLAN/NAT): Linux bridge/OVS, trunking; NAT via virbr0/dnsmasq eller egen brandvägg.
- HA/Live migration: Möjligt (Pacemaker/Corosync/virt-tools), men mer “bygg själv”.
- Backup-ekosystem: DIY: borg/restic/rsync + qemu-img/virsh; app-konsistens via agenter/skript.
- Styrkor: Maximal kontroll, inga licenser, ideal för automation/DevOps/labb.
- Begränsningar: Mest handpåläggning och Linuxkompetens; färre bekvämligheter för större team.
- Lämplighet: Labb/utbildning, CI/CD, speciallösningar där full kontroll prioriteras.

Nätmodell (VLAN/NAT): Linux bridge/OVS, trunking; NAT via virbr0/dnsmasq eller egen brandvägg.

HA/Live migration: Möjligt (Pacemaker/Corosync/virt-tools), men mer “bygg själv”.

Backup-ekosystem: DIY: borg/restic/rsync + qemu-img/virsh; app-konsistens via agenter/skript.

Styrkor: Maximal kontroll, inga licenser, ideal för automation/DevOps/labb.

Begränsningar: Mest handpåläggning och Linuxkompetens; färre bekvämligheter för större team.

Lämplighet: Labb/utbildning, CI/CD, speciallösningar där full kontroll prioriteras.

### 5.1.10 Snabba “recept” per plattform

Proxmox (Debian-bas):
VM på rätt VLAN: Trunka uplink, sätt vmbr0 VLAN-aware, ge vNIC VLAN-tagg.
NAT-labb: Skapa vmbrN med NAT; lägg kurs-VM:er där.
Snapshot + rollback: Snapshot → ändra → testa → rensa.
Enklast backup: PBS-target, daglig inkrementell + månatlig verifiering.

VMware vSphere/ESXi:
VM på rätt VLAN: Skapa port group med VLAN-ID, koppla vNIC dit.
NAT-labb: Använd Edge-VM (pfSense/OPNsense) eller NSX-Edge för NAT.
Snapshot + rollback: Snapshot via vCenter; rensa efter test.
Enklast backup: Veeam-jobb mot vCenter, GFS-retention, regelbunden restore-test.

Hyper-V (Windows):
VM på rätt VLAN: Virtual Switch + VLAN-ID på vNIC.
NAT-labb: Intern switch + Routing/NAT-roll i en liten gateway-VM.
Checkpoint + rollback: Checkpoint före ändring; “Apply”/Delete när klar.
Enklast backup: Windows Server Backup eller Veeam med VSS-konsistens.

XCP-ng:
VM på rätt VLAN: Skapa network med VLAN-tagg, koppla vNIC.
NAT-labb: Gateway-VM för NAT (t.ex. OPNsense).
Snapshot + rollback: Via XO/XOA, rensa när klart.
Enklast backup: XO-backup (delta), regelbunden verifiering.

libvirt/KVM:
VM på rätt VLAN: Linux bridge/OVS + trunk uthamnad; vNIC med VLAN-tagg.
NAT-labb: virbr0 (default NAT) eller egen dnsmasq/firewalld-NAT.
Snapshot + rollback: qemu-img/virsh snapshot.
Enklast backup: stoppa-konsistens + rsync/borg/restic; för app-konsistens använd agent/scripting.

### 

### 📌 Kontrollfrågor

- Ge tre skäl till att virtualisera som direkt påverkar tillgänglighet och arbetstakt.
- Förklara skillnaden mellan snapshot och backup och när respektive används.
- Varför bör management, lagring, backup och produktion separeras nätmässigt?
- När väljer du Proxmox framför vSphere – och tvärtom?
- Vad talar för Hyper-V i en Windows-tung skolmiljö?
- Hur sätter du en VM på rätt VLAN i vSphere, Hyper-V respektive Proxmox (kort steg för steg)?
- Vad innebär overcommit och vilka risker finns för RAM och I/O?
- Nämn två sätt att skapa ett isolerat NAT-labb utan att påverka produktion.
- Vilka komponenter behövs för HA + live migration i praktiken?
- Hur skulle du licensiera Windows-tunga VM-värdar kostnadseffektivt (Standard vs Datacenter)?

Ge tre skäl till att virtualisera som direkt påverkar tillgänglighet och arbetstakt.

Förklara skillnaden mellan snapshot och backup och när respektive används.

Varför bör management, lagring, backup och produktion separeras nätmässigt?

När väljer du Proxmox framför vSphere – och tvärtom?

Vad talar för Hyper-V i en Windows-tung skolmiljö?

Hur sätter du en VM på rätt VLAN i vSphere, Hyper-V respektive Proxmox (kort steg för steg)?

Vad innebär overcommit och vilka risker finns för RAM och I/O?

Nämn två sätt att skapa ett isolerat NAT-labb utan att påverka produktion.

Vilka komponenter behövs för HA + live migration i praktiken?

Hur skulle du licensiera Windows-tunga VM-värdar kostnadseffektivt (Standard vs Datacenter)?

### 

### 🔗 Fördjupningslänkar

- Proxmox VE docs: https://pve.proxmox.com/pve-docs/
- VMware vSphere docs: https://docs.vmware.com/
- Microsoft Hyper-V docs: https://learn.microsoft.com/windows-server/virtualization/hyper-v/
- XCP-ng & XO: https://xcp-ng.org/ och https://xen-orchestra.com/
- libvirt/KVM: https://libvirt.org/ och https://qemu.readthedocs.io/
- Linux bridge/OVS grunder: https://wiki.linuxfoundation.org/networking/bridge

Proxmox VE docs: https://pve.proxmox.com/pve-docs/

VMware vSphere docs: https://docs.vmware.com/

Microsoft Hyper-V docs: https://learn.microsoft.com/windows-server/virtualization/hyper-v/

XCP-ng & XO: https://xcp-ng.org/ och https://xen-orchestra.com/

libvirt/KVM: https://libvirt.org/ och https://qemu.readthedocs.io/

Linux bridge/OVS grunder: https://wiki.linuxfoundation.org/networking/bridge

### 

### ✍️ Egna anteckningar

…


